---
import BaseHead from '@/components/BaseHead'
import Header from '@/components/Header'
import Footer from '@/components/Footer'
import ProviderTheme from '@/components/ProviderTheme'
import ProviderAnimations from '@/components/ProviderAnimations'
import CloseIcon from '@/components/icons/CloseIcon'
import SchemaMarkup from '@/components/SchemaMarkup'
import '../styles/global.css'

const { title, description, image, articleDate } = Astro.props

// Esto controla los estados de confirmación de suscripción que llegan por la URL
const confirmation = Astro.url.searchParams.get('confirmation')
let confirm = ''

if (confirmation === 'needed') {
  confirm = 'not confirmed'
}

if (confirmation === 'success') {
  Astro.cookies.set('confirmed', 'true')
  confirm = 'confirmed'
}

// Tus datos de Schema.org para SEO estructurado
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Mindful ML",
  "url": "https://mindfulml.vialabsdigital.com",
  "description": "Blog sobre Machine Learning, Inteligencia Artificial y Deep Learning",
  "publisher": {
    "@type": "Organization",
    "name": "ViaLabs Digital",
    "url": "https://vialabsdigital.com"
  }
}

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "ViaLabs Digital",
  "url": "https://vialabsdigital.com",
  "sameAs": [
    "https://x.com/Rauljauregui",
    "https://www.linkedin.com/in/raúl-jáuregui-martínez-de-morentin-1b0732294/"
  ],
  "knowsAbout": [
    "Machine Learning",
    "Artificial Intelligence",
    "Deep Learning",
    "Technical SEO",
    "Web Development"
  ],
  "founder": {
    "@type": "Person",
    "name": "Raúl Jáuregui",
    "sameAs": [
      "https://x.com/Rauljauregui",
      "https://www.linkedin.com/in/raúl-jáuregui-martínez-de-morentin-1b0732294/"
    ]
  }
}

---
<html lang="es" class="scroll-smooth">
  <head>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX Stylesheet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">

    <!-- Google Analytics (Partytown for better performance) -->
    <script type="text/partytown" async src="https://www.googletagmanager.com/gtag/js?id=G-V3WC9QSH8J"></script>
    <script type="text/partytown">
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-V3WC9QSH8J');
    </script>

    <!-- Schema.org structured data -->
    <SchemaMarkup schema={websiteSchema} />
    <SchemaMarkup schema={organizationSchema} />

    <!-- Base Meta Tags -->
    <BaseHead title={title} description={description} ogImage={image} articleDate={articleDate} />

    <!-- Providers for Theme and Animations -->
    <ProviderTheme />
    <ProviderAnimations />
  </head>

  <body class="relative bg-white text-stone-950 dark:bg-[#0a0910] dark:text-white">
    <main class="mx-auto max-w-xs sm:max-w-2xl sm:px-8 lg:px-12 xl:px-16 antialiased md:max-w-6xl grid gap-12">
      
      <!-- Header (el estado de autenticación lo manejas en el cliente) -->
      <Header />

      <!-- Popups de confirmación o no confirmación del email -->
      {
        confirm === 'not confirmed' && (
          <div class="w-full bg-yellow-300 dark:bg-yellow-600 text-center flex justify-center items-center rounded-lg py-2 px-4" id="not-confirmed">
            <p class="flex-grow text-sm">
              Gracias pero todavía no hemos terminado. Hemos enviado un correo electrónico de confirmación.
              Por favor, revisa tu bandeja de entrada y haz clic en el botón para completar tu suscripción.
              (Si no lo encuentras revisa la bandeja de spam)
            </p>
            <button id="close-not-confirmed-pop-up">
              <CloseIcon />
            </button>
          </div>
        )
      }

      {
        confirm === 'confirmed' && (
          <div class="w-full bg-green-300 text-center flex justify-center items-center rounded-lg py-2 px-4" id="confirmed">
            <p class="flex-grow text-sm">
              ¡Correo electrónico confirmado correctamente!
            </p>
            <button id="close-confirmed-pop-up">
              <CloseIcon />
            </button>
          </div>
        )
      }

      <!-- Aquí se inyecta el contenido de las páginas -->
      <slot />

      <!-- Footer -->
      <Footer />

    </main>

    <!-- Lógica de UI para cerrar los popups -->
    <script>
      document.addEventListener('DOMContentLoaded', (event) => {
        const closeNotConfirmedPopup = document.getElementById('close-not-confirmed-pop-up');
        const notConfirmedPopup = document.getElementById('not-confirmed');

        if (closeNotConfirmedPopup && notConfirmedPopup) {
          closeNotConfirmedPopup.addEventListener('click', function () {
            notConfirmedPopup.style.display = 'none';
          });
        }

        const closeConfirmedPopup = document.getElementById('close-confirmed-pop-up');
        const confirmedPopup = document.getElementById('confirmed');

        if (closeConfirmedPopup && confirmedPopup) {
          closeConfirmedPopup.addEventListener('click', function () {
            confirmedPopup.style.display = 'none';
          });
        }

        // Comprobación de sesión de usuario (en el navegador)
        async function checkSession() {
          try {
            const res = await fetch('/api/check-session');
            const data = await res.json();
            
            if (data.authenticated) {
              console.log('Estás autenticado como:', data.email);
              // Aquí podrías mostrar un botón de logout o algo más
              const authStatus = document.getElementById('auth-status');
              if (authStatus) {
                authStatus.textContent = 'Estás logueado';
              }
            } else {
              const authStatus = document.getElementById('auth-status');
              if (authStatus) {
                authStatus.textContent = 'No has iniciado sesión';
              }
            }
          } catch (error) {
            console.error('Error al comprobar sesión:', error);
          }
        }

        checkSession();
      });
    </script>
  </body>
</html>
