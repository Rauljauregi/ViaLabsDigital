---
import {
  type CollectionEntry,
  getCollection,
  getEntryBySlug,
} from 'astro:content'
import BlogPost from '@/layouts/BlogPost'
import Share from '@/components/Share'
import TableOfContents from '@/components/TableOfContents'
import SchemaMarkup from '@/components/SchemaMarkup'
import RelatedCluster from '@/components/RelatedCluster.astro'
import readingTime from 'reading-time'

const slug = Astro.params.slug?.replace(/^\/+|\/+$/g, '') || ''

// 1) Cargar post y manejar 404
const post = await getEntryBySlug('blog', slug)
if (!post) {
  console.error(`No se encontró ningún post con el slug: ${slug}`)
  return Astro.redirect('/404')
}

// 2) Render del contenido
let Content, headings, remarkPluginFrontmatter
try {
  const rendered = await post.render()
  Content = rendered.Content
  headings = rendered.headings
  remarkPluginFrontmatter = rendered.remarkPluginFrontmatter
} catch (error) {
  console.error(`Error al renderizar el post ${slug}: ${error instanceof Error ? error.message : error}`)
  return Astro.redirect('/404')
}

// 3) Calcular meta (tiempo lectura, palabras, etc.)
const rawBody = post.body ?? ''
const stats = readingTime(rawBody)
const minutes = Math.max(1, Math.round(stats.minutes)) // al menos 1
const isoDuration = `PT${minutes}M`
const wordCount = rawBody ? rawBody.trim().split(/\s+/).length : undefined

// 4) Construir imagen absoluta (host del blog)
const host = 'https://mindfulml.vialabsdigital.com'
const imageAbs = post.data.heroImage
  ? (post.data.heroImage.startsWith('http')
      ? post.data.heroImage
      : `${host}${post.data.heroImage}`)
  : undefined

// 5) TechArticle schema mejorado
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'TechArticle',
  headline: post.data.title,
  description: post.data.description,
  image: imageAbs,
  datePublished: post.data.pubDate,
  dateModified: post.data.updatedAt ?? post.data.pubDate,
  author: {
    '@type': 'Person',
    name: 'Raúl Jáuregui',
    sameAs: [
      'https://x.com/Rauljauregui',
      'https://www.linkedin.com/in/raúl-jáuregui-martínez-de-morentin-1b0732294/',
    ],
  },
  publisher: {
    '@type': 'Organization',
    name: 'ViaLabs Digital',
    url: 'https://vialabsdigital.com',
    logo: {
      '@type': 'ImageObject',
      url: 'https://vialabsdigital.com/wp-content/uploads/ViaLabsDigital-1.png',
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': Astro.url.href,
  },
  keywords: Array.isArray(post.data.tags) ? post.data.tags.join(', ') : undefined,
  articleSection: post.data.category,
  wordCount,
  timeRequired: isoDuration, // ISO 8601 duration
}
---

<BlogPost
  data={post.data}
  headings={headings}
  readTime={`${minutes} min tiempo de lectura`}
>
  <!-- Schema.org -->
  <SchemaMarkup schema={articleSchema} />

  <div class="grid grid-cols-1 md:grid-cols-[20%_auto] gap-16 mt-8">
    <aside class="hidden md:block">
      <Share />
      {Array.isArray(headings) && headings.length > 0 && (
        <TableOfContents headings={headings} />
      )}
    </aside>

    <main>
      <article class="prose dark:prose-invert mb-16">
        <Content />
      </article>

      <!-- Clúster relacionado por money tag / categoría -->
      <RelatedCluster current={post as CollectionEntry<'blog'>} limitInitial={3} />
    </main>
  </div>
</BlogPost>
